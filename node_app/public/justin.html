<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
		<link rel="shortcut icon" type="image/x-icon" href="image-square.jpg"/>
		<title>Justin's Site</title>
		<style type="text/css" media="screen">
			body {
				background-color: #f7f7f7;
			}
			a.anchor {
				position: relative;
				display: block;
				visibility: hidden;
				top: -100px;
			}
    		#editor {
				height: 100%;
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
    		}
			.contentdiv {
				width: 100%;
				height: auto;
				position: relative;
				display: inline-block;
				text-align:center;
				margin: auto;
			}
    		img {
    		    max-width: 100%;
    		    max-height: 100%;
    		    display: block;
    		    margin: 0 auto;
    		}
			.codediv {
				/*width: 51%;*/
				height: 200px;
				position: relative;
				display: inline-block;
				margin: auto;
			}
			.texclass {
				width: 42%;
				height: 200px;
				position: relative;
    		    vertical-align: middle;
    		    text-align: center;
    		    display: inline-block;
				margin: auto;
			}
			.weatherdiv {
				width: 316px; 
				display: inline-block;
			}
			.outerweatherdiv {
				width: 51%;
				margin: auto;
				display: inline-block;
			}
			.rssdiv {
				/* width: 42%; */
				height: 422px;
				/* text-align: left;
				margin: auto;
				display: inline-block; */
				overflow-y: scroll;
			}
			.feature-new {
				min-width: 300px;
			}
			.row {
				margin-top: -30px;
			}
			.col {
				margin-top: 30px;
			}
			h3 {
				margin-top: 10px;
			}
			h3 a:link, h3 a:visited, h3 a:hover, h3 a:active {
				text-decoration: none;
				color: rgb(121, 191, 75);
			}
			h4 a:link, h4 a:visited, h4 a:hover, h4 a:active {
				text-decoration: none;
				color: rgb(69, 95, 105);
				font-size: 16px;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-expand-md fixed-top navbar-dark bg-dark">
			<a style="margin-left: 5%" class="navbar-brand" href="#"><div id="profpic"></div></a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			  <span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
			  <ul class="navbar-nav mr-auto">
					<li class="nav-item active">
						<a class="nav-link" href="#weather">Weather</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#news">News</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#latex">LaTeX</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#music">Music</a>
					</li>
			  </ul>
			</div>
		</nav>
		<div class="container px-4 py-5">
			<div id="welcome-text" class="d-flex justify-content-center"></div>
			<div class="row g-4 py-5 row-cols-1 row-cols-sm-2">
				<div class="feature feature-new col rssdiv border rounded">
					<a id="news" class="anchor"></a>
					<script src="//rss.bloople.net/?url=http%3A%2F%2Frss.slashdot.org%2FSlashdot%2FslashdotMain&showtitle=true&detail=-1&limit=5&type=js"></script>
					<hr/>
					<script src="//rss.bloople.net/?url=https%3A%2F%2Fwww.theverge.com%2Frss%2Ffrontpage&showtitle=true&detail=-1&limit=5&type=js"></script>
					<hr/>
					<h3><a href="https://cnn.com/">CNN - US</a></h3>
					<script src="//rss.bloople.net/?url=http%3A%2F%2Frss.cnn.com%2Frss%2Fcnn_topstories.rss&detail=-1&limit=3&showtitle=false&type=js"></script>
					<hr/>
					<h3><a href="https://bbc.co.uk/news/">BBC - World</a></h3>
					<script src="//rss.bloople.net/?url=http%3A%2F%2Ffeeds.bbci.co.uk%2Fnews%2Fworld%2Frss.xml&detail=-1&limit=3&showtitle=false&type=js"></script>
					<hr/>
					<h3><a href="https://xkcd.com/">XKCD</a></h3>
					<script src="//rss.bloople.net/?url=https%3A%2F%2Fxkcd.com%2Frss.xml&showtitle=false&detail=-1&limit=1&type=js"></script>
				</div>
				<div class="feature feature-new col">
					<a id="weather" class="anchor"></a>
					<div>
						<a style="height:200px" class="weatherwidget-io" href="https://forecast7.com/en/38d99n76d94/college-park/?unit=us" data-label_1="College Park" data-theme="original" >COLLEGE PARK</a>
						<script>
							!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
						</script>
					</div>
					<div>
						<a class="weatherwidget-io" href="https://forecast7.com/en/38d90n77d27/vienna/?unit=us" data-label_1="Vienna" data-theme="original" >Vienna</a>
						<script>
							!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
						</script>
					</div>
				</div>
			</div>
			<div class="row g-4 py-5 row-cols-1 row-cols-sm-2">
				<div class="feature feature-new col codediv border rounded d-flex flex-wrap align-items-center">
					<a id="latex" class="anchor"></a>
					<div id="editor">\frac{-\hbar^2}{2m} \frac{\text{d}^2 \Psi(x)}{\text{d}x^2} + U(x) \Psi(x) = E\Psi(x)</div>
				</div>
				<div id="texdiv" class="feature feature-new col d-flex flex-wrap align-items-center"></div>
			</div>
			<div class="row g-4 py-5 row-cols-1 row-cols-sm-3 align-middle">
				<a id="music" class="anchor"></a>
				<div id="tempodiv" class="feature feature-new col align-center text-center">
					<div style="width: 100%">
						<p width=100% class="border" style="padding: 50px; user-select: none;" id="tempo">Click here to find a tempo...</p>
					</div>
					<div>
						<button style="width: 100%" id="reset" class="btn btn-danger" onclick="reset()">Reset</button>
					</div>
				</div>
				<div class="feature feature-new col d-flex flex-wrap align-items-center">
					<img height=100% src="media/catjam.gif"/>
				</div>
				<div class="feature feature-new col border d-flex align-items-center justify-content-center" style="border-radius: 5px; background-color: #1ED760;">
					<button id="login-button" class="btn btn-dark">Log in with Spotify</button>
					<div id="songinfo" style="height: 100%; width:100%"></div>
				</div>
			</div>
		</div>
		<script src="src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
		<script>
			var editor = ace.edit("editor");
			editor.resize();
			editor.setTheme("ace/theme/tomorrow");
			editor.session.setMode("ace/mode/latex");

			function getImg(){
				queryStr = editor.getValue();
				var elem = document.getElementById("teximg"); 
				if(!elem) { elem = document.createElement("img"); }
				elem.setAttribute("src", "https://latex.codecogs.com/gif.latex?" + queryStr)
				elem.setAttribute("style", "vertical-align: middle");
				elem.setAttribute("id", "teximg")
				document.getElementById("texdiv").appendChild(elem);
			}
			setInterval(getImg, 100);
		</script>
		<script>
			$('.navbar-collapse a').click(function(){
				$(".navbar-collapse").collapse('hide');
			});
		</script>
		<script>
			document.addEventListener("click", tempo, false);


			var time = 0;
			var bpm = 0;
			var bpms = [];

			function reset(){
				time = -1;
				bpms = [];
			}

			function tempo(e) {
				var oldTime = time;
				var d = new Date();
				time = d.getTime();
				// var press = e.keyCode;
				var div = document.getElementById('tempodiv')
				if(div === e.target || div.contains(e.target)){
					if(oldTime == -1){
						document.getElementById("tempo").innerHTML = "Click here to find a tempo...";
						time = 0;
					}else{
						bpm = 60/((time-oldTime)/1000);
						bpms.push(bpm);
						if(bpms.length > 500){
							bpms.shift();
						}
						if(oldTime == 0){
							document.getElementById("tempo").innerHTML = "First beat";
						}else{
							var total = 0;
							for(var x = 0; x<bpms.length; x++){
								total += bpms[x];
							}
							total = total/(bpms.length-1);
							document.getElementById("tempo").innerHTML = Math.round(total) + " BPM";
							// document.getElementById("tempo").innerHTML = "Time Between: " +
							// (time-oldTime) + " ms <br/>" + bpm + " BPM <br />Average: " + total
							// + " BPM <br />Nearest Whole Number Average: " + Math.round(total) +
							// " BPM<br />Press enter to start a new tempo," +
							// " or press any other key to add to the average.";
						}
					}
				}
			}
		</script>
		<script id="profpic-template" type="text/x-handlebars-template">
			{{#if images.0.url}}
			<img src="{{images.0.url}}" style="border-radius: 30px" width=40px />
			{{else}}
			<img src="image-square.jpg" style="border-radius: 30px" width=40px />
			{{/if}}
		</script>
		<script id="welcome-text-template" type="text/x-handlebars-template">
			<div style="margin-top: 50px">
				<h1 class="display-4">Hello {{display_name}}!</h1>
			</div>
		</script>
		<script id="songinfo-template" type="text/x-handlebars-template">
			<h2>Current Song Info</h2>
			<table class="table table-bordered table-dark">
				<tr>
					<th>Time</th>
					<th>Danceability</th>
				</tr>
				<tr>
					<td>{{formatMilliToMinuteSecond progress_ms}}/{{formatMilliToMinuteSecond item.duration_ms}}</td>
					<td>{{danceability}}</td>
				</tr>
				<tr>
					<th>Song</th>
					<th>Tempo</th>
				</tr>
				<tr>
					<td>{{item.name}}</td>
					<td>{{tempo}}</td>
				</tr>
				<tr>
					<th>Artist</th>
					<th>Key</th>
				</tr>
				<tr>
					<td>{{item.artists.0.name}}</td>
					<td>{{key}}</td>
				</tr>
				<tr>
					<th>Album</th>
					<td rowspan='2' ><img src="{{item.album.images.[0].url}}"/></td>
				</tr>
				<tr>
					<td>{{item.album.name}}</td>
				</tr>
			</table>
			<!-- <div style="float:left; width: 45%">
				<h2>Current Song Info</h2>
				<img src="{{item.album.images.[0].url}}"/>
				<p>
					<b>Time</b><br/>{{formatMilliToMinuteSecond progress_ms}}/{{formatMilliToMinuteSecond item.duration_ms}}<br/>
					<b>Song</b><br/>{{item.name}}<br/>
					<b>Artist</b><br/>{{item.artists.0.name}}<br/>
					<b>Album</b><br/>{{item.album.name}}<br/>
				</p>
			</div>
			<div style="float: left; height:100%; width: 45%" class="d-flex align-items-center">
				<div>
					<p>
						<b>Danceability</b><br/>{{danceability}}<br/>
						<b>Tempo</b><br/>{{tempo}}<br/>
						<b>Time Signature</b><br/>{{time_signature}}<br/>
					</p>
				</div>
			</div> -->
    </script>
		<script type='text/javascript' src='config.js'></script>
		<script>
			var profpicSource = document.getElementById('profpic-template').innerHTML,
			profpicTemplate = Handlebars.compile(profpicSource),
			profpicPlaceholder = document.getElementById('profpic');
			profpicPlaceholder.innerHTML = profpicTemplate({})
			var welcomeTextSource = document.getElementById('welcome-text-template').innerHTML,
			welcomeTextTemplate = Handlebars.compile(welcomeTextSource),
			welcomeTextPlaceholder = document.getElementById('welcome-text');
			$('#profpic').show();
			$('#songinfo').hide();
			$('#welcome-text').hide();

			(function(){
				var stateKey = 'spotify_auth_state';
				function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }
				function generateRandomString(length) {
						var text = '';
						var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	
						for (var i = 0; i < length; i++) {
							text += possible.charAt(Math.floor(Math.random() * possible.length));
						}
						return text;
					};
				var songinfoSource = document.getElementById('songinfo-template').innerHTML,
				songinfoTemplate = Handlebars.compile(songinfoSource),
				songinfoPlaceholder = document.getElementById('songinfo');
				var params = getHashParams();
				var access_token = params.access_token,
				state = params.state,
				storedState = localStorage.getItem(stateKey);

				// Formating for time with handlebars
        Handlebars.registerHelper('formatMilliToMinuteSecond', function(value) {
          var minutes = parseInt(value/60000);;
          var seconds = parseInt((value-minutes*60000)/1000);
          if(seconds < 10){
            seconds = "0" + seconds;
          }
          return '' + minutes + ":" + seconds;
        });

				if (access_token && (state == null || state !== storedState)) {
					alert('There was an error during the authentication')
				}else{
					localStorage.removeItem(stateKey);
					if(access_token){
						$.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
								// console.log(response)
                profpicPlaceholder.innerHTML = profpicTemplate(response);
								welcomeTextPlaceholder.innerHTML = welcomeTextTemplate(response);
								$('#welcome-text').show();
							}
						});
						setInterval(getSongInfo, 500);
						function getSongInfo(){
							$.ajax({
								url: 'https://api.spotify.com/v1/me/player',
								headers: {
									'Authorization': 'Bearer ' + access_token
								},
								success: function(response) {
									// console.log(response)
									// songinfoPlaceholder.innerHTML = songinfoTemplate(response);
									// if(waitTil < Date.now() && Array.isArray(queue.items) && queue.items.length && response.progress_ms <= 3000 && response.item.name == queue.items[0].songTitle){
									// 	removeFromQueue();
									// 	waitTil = new Date(Date.now() + 3000);
									// }
									$('#songinfo').show();
									$('#login-button').hide();
									if(response === undefined || response.item === undefined){
										songinfoPlaceholder.innerHTML = '<div style="height: 100%" class="d-flex align-items-center text-center"><p>Nothing is playing, head to Spotify and play a song to see its details.</p></div>'
									}else{
										currentSong = response.item.name;
										uri = response.item.id;
	
										$.ajax({
											url: 'https://api.spotify.com/v1/audio-features/' + uri,
											headers: {
												'Authorization': 'Bearer ' + access_token
											},
											success: function(responseExtra){
												// console.log(responseExtra);
												combinedResponses = { ...response, ...responseExtra}
												songinfoPlaceholder.innerHTML = songinfoTemplate(combinedResponses);
												
											}
										});
									}
								}
							});
						}
					}
				}
				document.getElementById('login-button').addEventListener('click', function() {
					var client_id = config.client_id;
					var redirect_uri = 'https://justin-thoms.com/justin'; // Your redirect uri
	
					var state = generateRandomString(16);
	
					localStorage.setItem(stateKey, state);
					var scope = 'user-read-private user-read-email user-follow-read user-read-playback-state user-modify-playback-state';
	
					var url = 'https://accounts.spotify.com/authorize';
					url += '?response_type=token';
					url += '&client_id=' + encodeURIComponent(client_id);
					url += '&scope=' + encodeURIComponent(scope);
					url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
					url += '&state=' + encodeURIComponent(state);
	
					window.location = url;
				}, false);
			})();
		</script>
	</body>
</html>
